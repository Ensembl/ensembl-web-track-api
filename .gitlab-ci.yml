stages:
    - build
    - deploy

variables:
    CONTAINER_IMAGE: ${CI_REGISTRY_IMAGE}:${CI_COMMIT_SHORT_SHA}
    DOCKER_TLS_CERTDIR: ""

#Base templates
.build:
    stage: build
    image: docker
    services:
        - docker:dind
    before_script:
        - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
    script:
        - docker build -t ${CONTAINER_IMAGE} --no-cache -f Dockerfile .
        - docker push ${CONTAINER_IMAGE}
        - docker rmi ${CONTAINER_IMAGE}
        - docker logout $CI_REGISTRY

.deploy:
    stage: deploy
    image: dockerhub.ebi.ac.uk/ensembl-web/deploy-tools:0.1
    script:
        - sed -i "s#<DOCKER_IMAGE>#${CONTAINER_IMAGE}#g" k8s/deployment.yaml
        - kubectl apply -f k8s/deployment.yaml

.deploy:review:
    stage: deploy
    image: dockerhub.ebi.ac.uk/ensembl-web/deploy-tools:0.1
    script: #Fill placeholders and apply manifest files
        - sed -i "s#<BRANCH_NAME>#${CI_COMMIT_REF_SLUG}#g" k8s/deployment_dev.yaml
        - sed -i "s#<DOCKER_IMAGE>#${CONTAINER_IMAGE}#g" k8s/deployment_dev.yaml
        - kubectl apply -f k8s/deployment_dev.yaml
        - sed -i "s#<BRANCH_NAME>#${CI_COMMIT_REF_SLUG}#g" k8s/ingress_dev.yaml
        - kubectl apply -f k8s/ingress_dev.yaml

#Build docker image 
Docker:
    extends: .build

#Deploy review app (from feature branch to HX k8s cluster)
Review:WP-HX:
    extends: .deploy:review
    environment:
        name: wp-hx-dev-ing
    except:
        - main

#Deploy main branch to dev environment (in HX cluster)
Dev:WP-HX:
    extends: .deploy
    environment:
        name: wp-hx-dev
    only:
        - main

#Deploy to staging in HX
Staging:WP-HX:
    extends: .deploy
    environment:
        name: wp-hx-staging
    only:
        - main


#Deploy to staging in HH
Staging:WP-HH:
    extends: .deploy
    environment:
        name: wp-hh-staging
    only:
        - main


#Deploy to internal in HX
Internal:WP-HX:
    extends: .deploy
    environment:
        name: wp-hx-internal
    only:
        - main

#Deploy to internal in HH
Internal:WP-HH:
    extends: .deploy
    environment:
        name: wp-hh-internal
    only:
        - main

#Deploy to live in HX
Live:WP-HX:
    extends: .deploy
    environment:
        name: wp-hx-live
    only:
        - main

#Deploy to live in HH
Live:WP-HH:
    extends: .deploy
    environment:
        name: wp-hh-live
    only:
        - main