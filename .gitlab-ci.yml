stages:
    - build
    - deploy

variables:
    CONTAINER_IMAGE: ${CI_REGISTRY_IMAGE}:${CI_COMMIT_SHORT_SHA}
    DOCKER_TLS_CERTDIR: ""

#Base templates
#Build & upload new Docker image
.build:
    stage: build
    image: docker
    services:
        - docker:dind
    before_script:
        - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
    script:
        - docker build -t ${CONTAINER_IMAGE} --no-cache -f Dockerfile .
        - docker push ${CONTAINER_IMAGE}
        - docker rmi ${CONTAINER_IMAGE}
        - docker logout $CI_REGISTRY

#Deploy to k8s cluster (for main/dev branch)
.deploy:
    stage: deploy
    image: dockerhub.ebi.ac.uk/ensembl-web/deploy-tools:0.1
    script:
        - sed -i "s#<DOCKER_IMAGE>#${CONTAINER_IMAGE}#g" k8s/deployment.yaml
        - kubectl apply -f k8s/deployment.yaml

#Deploy review app (for feature branch)
.deploy-review:
    stage: deploy
    image: dockerhub.ebi.ac.uk/ensembl-web/deploy-tools:0.1
    script: #Fill placeholders and apply manifest files
        - sed -i "s#<DOCKER_IMAGE>#${CONTAINER_IMAGE}#g" k8s/review/deployment.yaml
        - sed -i "s#<BRANCH_NAME>#${CI_COMMIT_REF_SLUG}#g" k8s/review/deployment.yaml
        - sed -i "s#<BRANCH_NAME>#${CI_COMMIT_REF_SLUG}#g" k8s/review/service.yaml
        #- sed -i "s#<BRANCH_NAME>#${CI_COMMIT_REF_SLUG}#g" k8s/review/ingress.yaml
        - kubectl apply -f k8s/review/deployment.yaml
        - kubectl apply -f k8s/review/service.yaml
        #- kubectl apply -f k8s/review/ingress.yaml #done by FE review app deployment

#Stop review app (cleanup resources) 
.stop-review:
    stage: deploy
    image: dockerhub.ebi.ac.uk/ensembl-web/deploy-tools:0.1
    variables:
        GIT_STRATEGY: none
    when: manual
    script:
        #- kubectl delete ingress ensembl-track-api-${CI_COMMIT_REF_SLUG}-ingress
        - kubectl delete service ensembl-track-api-${CI_COMMIT_REF_SLUG}-service
        - kubectl delete deploy ensembl-track-api-${CI_COMMIT_REF_SLUG}-deployment

#Build docker image 
Docker:
    extends: .build

#Deploy feature branch to dev (review apps with custom BE and production DB)
Review:WP-HX:
    extends: .deploy-review
    environment:
        name: wp-hx-dev-ing
        url: http://$CI_COMMIT_REF_SLUG.review.ensembl.org
        on_stop: Stop_review
    except:
        - main
        - dev
        - update

#Deploy special feature branch to dev (review apps with custom BE and internal DB)
Review_db:WP-HX:
    extends: .deploy-review
    environment:
        name: wp-hx-dev-ing
        url: http://update-track-api.review.ensembl.org
    after_script: #restart deployment with new env that points to internal track database
        - sed -i "s#<BRANCH_NAME>#${CI_COMMIT_REF_SLUG}#g" k8s/review/ingress.yaml
        - kubectl apply -f k8s/review/ingress.yaml
        - kubectl set env deployment/ensembl-track-api-update-deployment  
          --from configmap/ensembl-track-api-review-configmap
    only:
        - update


#Stop review appp
Stop_review:
    extends: .stop-review
    environment:
        name: wp-hx-dev-ing
        action: stop
    except:
        - main
        - dev
        - update

#Deploy main branch to dev (default/production BE for review apps)
Dev:WP-HX:
    extends: .deploy
    environment:
        name: wp-hx-dev
    only:
        - main

#Deploy dev branch to staging in HX (approved review apps)
Staging:WP-HX:
    extends: .deploy
    environment:
        name: wp-hx-staging
    only:
        - dev


#Deploy dev branch to staging in HH
Staging:WP-HH:
    extends: .deploy
    environment:
        name: wp-hh-staging
    only:
        - dev


#Deploy main branch to internal in HX
Internal:WP-HX:
    extends: .deploy
    environment:
        name: wp-hx-internal
    only:
        - main

#Deploy main branch to internal in HH
Internal:WP-HH:
    extends: .deploy
    environment:
        name: wp-hh-internal
    only:
        - main

#Deploy main branch to live in HX (manual confirmation)
Live:WP-HX:
    extends: .deploy
    environment:
        name: wp-hx-live
    only:
        - main
    when: manual

#Deploy main branch to live in HH (manual confirmation)
Live:WP-HH:
    extends: .deploy
    environment:
        name: wp-hh-live
    only:
        - main
    when: manual

#Deploy job for new k8s cluster
Staging:WP40:HL:
    extends: .deploy
    environment:
        name: wp40-hl-staging
    only:
        - main
    when: manual

Internal:WP40:HL:
    extends: .deploy
    environment:
        name: wp40-hl-internal
    only:
        - main
    when: manual

Dev:WP40:HL:
    extends: .deploy
    environment:
        name: wp40-hl-dev
    only:
        - main
    when: manual

Dev:WP41:HX:
    extends: .deploy
    environment:
        name: wp41-hx-dev
    only:
        - main
    when: manual

Prod:WP41:HX:
    extends: .deploy
    environment:
        name: wp41-hx-prod
    only:
        - main
    when: manual
